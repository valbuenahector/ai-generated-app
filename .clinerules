# .clinerules — AppWorld 2026 (Module 2 + Module 3 Guardrails)
# Purpose:
#   - Guardrail vibe coding for Module 2 (base app) and Module 3 (incremental features)
#   - Prevent scope bleed, CI/CD breakage, or architectural churn
#   - Ensure deterministic behavior with Gemini + Cline
#
# AUTHORITATIVE:
#   These rules override any generic “best practice” suggestions.
#
# Lab theme:
#   Code fast → Observe risk → Secure with F5XC → Repeat

===============================================================================
0) GLOBAL LAB CONSTRAINTS (NON-NEGOTIABLE)
===============================================================================

- LAB-ONLY application for AppWorld 2026.
- This is NOT production software.
- Do NOT refactor large portions of the app unless explicitly instructed.
- Incremental change only — no rewrites.
- Every change must be explainable within a 2-hour lab.

===============================================================================
1) MODULE AWARENESS & PHASE CONTROL
===============================================================================

The assistant MUST know which module is active.

MODULE 2 — Base App (Already Exists):
- No APIs
- No login
- No forms
- No OpenAPI
- Purpose: CI/CD + baseline security controls

MODULE 3 — Incremental Features:
- APIs + OpenAPI
- Login page
- Contact form
- Purpose: API Security + Bot Defense

If the active module is unclear:
- STOP
- ASK the user which module they are in
- DO NOT implement changes

===============================================================================
2) STRICT SCOPE BOUNDARIES
===============================================================================

-------------------------
MODULE 2 — DO NOT BUILD
-------------------------
- /api endpoints
- openapi/openapi.json
- login or authentication logic
- HTML forms with POST
- Bot protection logic
- Rate limiting
- Databases or persistent storage

-------------------------
MODULE 3 — NOW ALLOWED
-------------------------
- API endpoints under /api/*
- openapi/openapi.json (OpenAPI 3.x)
- Login page (demo-only)
- Contact form
- In-memory data handling only

===============================================================================
3) CI/CD FEATURE DETECTION (CRITICAL)
===============================================================================

CI/CD uses FILE PRESENCE to enable security features.
DO NOT rename, move, or omit these files.

Feature triggers:

API Discovery:
- REQUIRED file: openapi/openapi.json

Bot Defense (Advanced):
- REQUIRED file: app/templates/login.html

Rules:
- These files MUST NOT exist in Module 2
- These files MUST exist in Module 3
- openapi/openapi.json MUST be valid JSON
- login.html MUST render a real page

===============================================================================
4) MODULE 3 — API ENDPOINT RULES
===============================================================================

API requirements:
- Prefix all routes with /api/
- JSON responses only
- 2–4 endpoints maximum
- Readable, intentionally simple logic

MANDATORY endpoints:
- GET /api/status
- GET /api/vibe-coding
- GET /api/ai-assisted-coding

Rules:
- No authentication
- Basic input handling only
- Include at least ONE lab-safe weakness (see Section 8)

===============================================================================
5) MODULE 3 — OPENAPI SPEC RULES
===============================================================================

Location:
- openapi/openapi.json

Requirements:
- OpenAPI version: 3.0.x
- Must document ALL implemented /api routes
- Minimal schemas only

OpenAPI MUST include:
- info (title, version)
- servers (placeholder URL only)
- paths
- request/response schemas

DO NOT:
- Auto-generate from code
- Over-model schemas
- Add security schemes

===============================================================================
6) MODULE 3 — LOGIN PAGE GUARDRAILS
===============================================================================

Purpose:
- Generate bot signals (NOT real auth)

Requirements:
- File: app/templates/login.html
- Routes:
  - GET  /login
  - POST /login
- Hardcoded or in-memory demo user
- Server-side credential check

DO NOT:
- Store passwords
- Add MFA, OAuth, SSO, or external IdPs

Bot-relevant behavior (required):
- Predictable login flow
- No rate limiting
- Simple username/password form

===============================================================================
7) MODULE 3 — CONTACT FORM RULES
===============================================================================

Requirements:
- File: app/templates/contact.html
- Routes:
  - GET  /contact
  - POST /contact
- Store submissions in memory or logs only
- Minimal client-side validation

DO NOT:
- Persist data
- Send emails
- Upload files

===============================================================================
8) INTENTIONAL LAB-SAFE WEAKNESSES
===============================================================================

Purpose:
- Enable WAAP, API Security, Bot Defense, WAS demos

Allowed (choose 1–2):
- Missing security headers
- Verbose error messages
- Overly permissive input validation
- No rate limiting on login/contact

NOT allowed:
- Real exploit payloads
- Command execution
- Persistent XSS
- Secrets or credentials

All weaknesses must be:
- Non-destructive
- Lab-only
- Easy to explain and mitigate later

===============================================================================
9) RUNTIME & DOCKER RULES (ALL MODULES)
===============================================================================

Docker:
- Single Dockerfile only
- App MUST bind to 0.0.0.0

Ports:
- Module 1 demo app: 5000
- Module 2 / 3 app: 5001

Local testing:
- flask run ONLY for jump host testing

vK8s:
- Must use gunicorn
- Any port is valid as long as:
  - containerPort
  - origin pool port
  - LB origin port
  all match

===============================================================================
10) TESTING & FAILURE STOP CONDITIONS
===============================================================================

Tests:
- MUST use pytest
- MUST run in CI
- No external dependencies

Module 2 tests:
- App imports
- GET / returns 200
- GET /healthz returns 200

Module 3 additional tests:
- API endpoints return JSON
- GET /login returns 200 (if implemented)
- GET /contact returns 200 (if implemented)
- openapi/openapi.json parses as valid JSON

Failure handling:
- If pytest fails:
  1) Analyze output
  2) Apply targeted fix
  3) Re-run pytest

STOP CONDITION:
- If the SAME test fails 5 times consecutively:
  - STOP coding
  - Report failing test + error
  - Instruct user to consult Lab Assistant

PROHIBITED:
- Disabling tests
- Weakening assertions
- Refactoring unrelated code

===============================================================================
11) DOCUMENTATION UPDATES (MODULE 3 ONLY)
===============================================================================

When moving from Module 2 → Module 3:

README.md:
- List new features
- Mention OpenAPI file location

todo.md:
- Add security follow-ups

CHANGELOG.md:
- v0.2 – Module 3 features

===============================================================================
12) OUTPUT EXPECTATION
===============================================================================

When implementing Module 3:
- Provide minimal diffs or full updated files
- Explicitly list:
  - New routes
  - New templates
  - OpenAPI changes
  - Test updates
- Do NOT refactor unrelated code

===============================================================================
13) FINAL MESSAGE TO STUDENT
===============================================================================

How to run:

- Open Jump Host → Firefox
- Use bookmarks in folder called "Module 2" to access the app and API endpoints

Run app:
- Open a new VSCode terminal
- Use command: python3 app.py"

Stop app:
- Open a new VSCode terminal
- Use command: pkill -f "python3 app.py"

END OF RULES
